__author__ = 'zyu'

import paramiko
from lib_util import Util

class DockerHelper(object):

    logger = Util.ibm_logger()

    def __init__(self, git_host, init_user,init_pwd):
        self._git_host = git_host
        self._init_user = init_user
	self._init_pwd = init_pwd

    #create user for student
    def init_user(self,host,user_name,user_pwd):
	self.logger.info("init_user " + host + " " + user_name + " " + user_pwd)
	cmd =  "./myuseradd-ibm " + user_name + " " + user_pwd
        print cmd
        ssh=paramiko.SSHClient()
        ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
        ssh.connect(host, username=self._init_user, password=self._init_pwd)
        stdin,stdout,stderr=ssh.exec_command(cmd)
        print stdout.read()
        ssh.close()

    #initialize git config
    def init_git(self,host,user_name,user_pwd,email,git_name,private_key,public_key):
	self.logger.info("init docker git" + " " + email + " " + user_name)
	cmd = "umask 0002 ; mkdir .ssh ; "
        cmd += "echo -ne '" + private_key + "' >~/.ssh/id_rsa ; "
        cmd += "echo '" + public_key + "' >~/.ssh/id_rsa.pub ; "
        cmd += "chmod 0600 ~/.ssh/id_rsa ; "
        cmd += "eval 'ssh-agent -s' ; "
        cmd += "ssh-add ~/.ssh/id_rsa ; "
        cmd += "git config --global user.name '" + user_name + "' ; "
        cmd += "git config --global user.email " + email + " ; "
        #cmd += "sudo echo -ne 'StrictHostKeyChecking no\\nUserKnownHostsFile /dev/null\\n' >> /etc/ssh/ssh_config && "
        cmd += "mkdir ucore_lab ; cd ./ucore_lab && git init ; "
        #cmd += "git remote add origin_edx " + repo_url +"; " 
        cmd += "git remote add origin_edx git@" + self._git_host + ":" + git_name + "/ucore_lab.git ; "
        cmd += "git pull origin_edx master"
	self.logger.info("cmd" + cmd)
        print cmd
        ssh=paramiko.SSHClient()
        ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
        ssh.connect(host, username=user_name, password=user_pwd)
        stdin,stdout,stderr=ssh.exec_command(cmd)
        print stdout.read()
        ssh.close()

if __name__ == "__main__":
    git_host = "172.16.13.236"
    init_user = "opuser"
    init_pwd = "p@ssw0rd"
    host = "172.16.15.238"
    user_name = "zhangysh1995"
    user_pwd = "p@ssw0rd"

    email = "zhangysh1995@163.com"
    private_key = "-----BEGIN RSA PRIVATE KEY-----\nMIIEqAIBAAKCAQEAoMgmbPYlgFTFbN/2alBSYjVG16rx7XyM6Girbhebi7AOVUST\numLt0gLz4Uj+t5epv/DbthN7a+cyP2jaP7Aa86GDABH5jIOvZxVM/bgKr+9uwqgZ\n1irGBKk8Na44JrbItkXHSR+oeO/td9d5j82SBEgeZIsT4Bu3K63XTWmTs+LB/eWg\nucctMTu684pqLJTNV35qUGj/6pmoOTQokDFq7w6+wKmKKV5scXdA2Wa1riagFBxH\nOHjnnz7zNa9gaqcGkQjDAErb/mYXx+kpxvuQX5gctaOtLjz6w35VT9w09ItIfhVc\nhkXm/jh4uL0wKGA+eJKWpNxmaPB8GcX8I6TtXwIDAQABAoIBAFr2AS9B7qN00iCv\ncERjXshq5cJb1vUJstpFZT8qofhcSS+aVY1sLKnUu87nshuB9So/BL40tW2tZfMT\nye2gHw9Yf7mJcco6MgC6v00HUxyH8/yyh7NvjYnTiNnBz8ivPkxIm99VxsVsz8cu\nI3rkzUgY2QD+4ea3J2DRv+3u3f41VPQsK4CpqkptVgHmevgPhlYAOvR9HYkroKN2\nT7cdFHhOQW36wiE0noY+Entz4DNGUJxpgxn7Q0h4tDMFjcwFN84aANg1IH30tHjO\nDe3/BzwU91ATC3F7nd2DnhaHywlcJzLGrZC3QJPlug5ocxU7wpiNf3pIFEY0p/m9\nmzIEmikCggCBAMXzSST4v/w/lp+czSDng5qrAkizlQSW7gxR+YAek6jg5HywGaWc\nX8XJy6xB0kXy7F1OrZ90HQmNfEoTciKbfD6KE/ZqtejNXeOaXSKPPOD9dPNv6Bxf\nRImilqGBD0GoNYAi+RVMhnCnHItuz4ZC16kr51Tl9eiPLbscycn0m2nzAoIAgQDP\n7oQLJhwLEmOPFAKthutbt7p+VfPN/VWwqiNVS9mKXhLFRvKrI8HfQmkwLPURagbJ\nxxv0vEx5syP5xh0PgqFMld4xrCAZdLrUFzbLGXf84RcFMiKVuk/INTN9TWHtCqaa\ne4j7KY7YZczEPYR0pN3ZQkGaaltxpfhfk3rHD+795QKCAIEAj7+kllytzpi+4RoV\nPJfjUiZtei4vQS35oKjG7utFf5YRVxrrBQER66gnZ+hEstc+HmRMYUcI7y732zNT\n5x3Sk/fhl0jW4UCBtg8bI0WxiBGHJGFXxYLJWsnfaVk3ow5sC6laCMWRu60fZYIK\n4g0YX5mqXFTCxydypja5sxcW5VECggCAGUFHGHOQhGe/X+l2Sc1RWNp/9EhMTICw\nn7yKfhmwWnYCoaN0ZgT5zzwpuog7W9oc6PUeGCOmxkFT5UqCzRd4r+ykCDR30Z+z\n8X7AUPrO8BAG08K7IKR4fEC5+EYl1rysb6cBhEAP8YirzkoKhIBh0bmSbkbsxGj8\nOd+X0gXFaWECggCAQPdT5APvW47bAlILzMFQ1Bvucah7QXjY32AoxxOvKJ11ywlP\n/ETWKTN9+oHtW/QPmIgnxoWqT1PHRp95NqwV8Mh86VosYjhFXCOwW3JFyGxqmPV5\nY97zL0Kf1pnWX6LtXFY2M+UZk5qrEpBwuboqTliCu2KcwOuq+a/p2icIwrE=\n-----END RSA PRIVATE KEY-----\n"
    public_key = "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCgyCZs9iWAVMVs3/ZqUFJiNUbXqvHtfIzoaKtuF5uLsA5VRJO6Yu3SAvPhSP63l6m/8Nu2E3tr5zI/aNo/sBrzoYMAEfmMg69nFUz9uAqv727CqBnWKsYEqTw1rjgmtsi2RcdJH6h47+1313mPzZIESB5kixPgG7crrddNaZOz4sH95aC5xy0xO7rzimoslM1XfmpQaP/qmag5NCiQMWrvDr7AqYopXmxxd0DZZrWuJqAUHEc4eOefPvM1r2BqpwaRCMMAStv+ZhfH6SnG+5BfmBy1o60uPPrDflVP3DT0i0h+FVyGReb+OHi4vTAoYD54kpak3GZo8HwZxfwjpO1f zhangysh1995@163.com"

    docker = DockerHelper(git_host,init_user,init_pwd)
    docker.init_user(host,user_name,user_pwd)
    docker.init_git(user_name,email,private_key,public_key)
